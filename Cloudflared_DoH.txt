Configuring DNS-Over-HTTPS ON Ubuntu And Bind 9
================================================

DOC
=====
Link : https://docs.pi-hole.net/guides/dns/cloudflared/

# mengganti waktu server localtime jakarta
> mv /etc/localtime /etc/localtime-asal && cp /usr/share/zoneinfo/Asia/Jakarta /etc/localtime && timedatectl set-timezone Asia/Jakarta

# mengubah timezone asia-jakarta
> timedatectl set-timezone Asia/Jakarta 

Installing cloudflared
======================
# For Debian/Ubuntu
> wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
> sudo apt-get install ./cloudflared-linux-amd64.deb
> cloudflared -v

Configuring cloudflared to run on startup
=========================================
Create a cloudflared user to run the daemon:
> sudo useradd -s /usr/sbin/nologin -r -M cloudflared

Proceed to create a configuration file for cloudflared:
> sudo nano /etc/default/cloudflared
Masukan :
# Commandline args for cloudflared, using Cloudflare DNS
CLOUDFLARED_OPTS=--port 5053 --upstream https://1.1.1.1/dns-query --upstream https://1.0.0.1/dns-query --address 0.0.0.0

Update the permissions for the configuration file and cloudflared binary to allow access for the cloudflared user:
> sudo chown cloudflared:cloudflared /etc/default/cloudflared
> sudo chown cloudflared:cloudflared /usr/local/bin/cloudflared

Then create the systemd script by copying the following into /etc/systemd/system/cloudflared.service.
This will control the running of the service and allow it to run on startup:
> sudo nano /etc/systemd/system/cloudflared.service
Masukan :
[Unit]
Description=cloudflared DNS over HTTPS proxy
After=syslog.target network-online.target

[Service]
Type=simple
User=cloudflared
EnvironmentFile=/etc/default/cloudflared
ExecStart=/usr/local/bin/cloudflared proxy-dns $CLOUDFLARED_OPTS
Restart=on-failure
RestartSec=10
KillMode=process

[Install]
WantedBy=multi-user.target


Enable the systemd service to run on startup,
then start the service and check its status:
> sudo systemctl enable cloudflared
> sudo systemctl start cloudflared
> sudo systemctl status cloudflared


TEST
pi@raspberrypi:~ $ dig @127.0.0.1 -p 5053 google.com

; <<>> DiG 9.11.5-P4-5.1-Raspbian <<>> @127.0.0.1 -p 5053 google.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 12157
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 22179adb227cd67b (echoed)
;; QUESTION SECTION:
;google.com.                    IN      A

;; ANSWER SECTION:
google.com.             191     IN      A       172.217.22.14

;; Query time: 0 msec
;; SERVER: 127.0.0.1#5053(127.0.0.1)
;; WHEN: Wed Dec 04 09:29:50 EET 2019
;; MSG SIZE  rcvd: 77




IP ADDRESS LOCALHOST
127.0.0.1#5053

DI BIND 9 (JIKA MENGGUNAKAN DOH CLOUDFLARE)
=============================================
> nano /etc/bind/named.conf.options
acl goodclients {
        0.0.0.0/0;
        localhost;
        localnets;
};
options {
    directory "/var/cache/bind";
    recursion yes;
    allow-query { goodclients; };

    # Forward semua ke cloudflared DoH
    forwarders {
        127.0.0.1 port 5053;
    };
    forward only;

    dnssec-validation auto;
    auth-nxdomain no;
    listen-on { any; };
    listen-on-v6 { any; };

    # Statistik untuk monitoring
    statistics-file "/var/cache/bind/named.stats";
};


BIND 9 SETTINGAN BIASA AJA
===========================
acl goodclients {
        0.0.0.0/0;
        localhost;
        localnets;
};
options {
    directory "/var/cache/bind";
    recursion yes;
    allow-query { goodclients; };

    forwarders {
        203.142.82.222;
        1.1.1.1;
        8.8.8.8;
        203.142.84.222;
    };

    forward only;
    dnssec-validation auto;
    auth-nxdomain no;
    listen-on { any; };
};



======== Pudin Saepudin : italazhar.com
